<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="_layout">

<body>
	<div layout:fragment="content">
		<section class="wrapper">
			<div class="row">
				<div class="col-lg-12">
					<h3 class="page-header"><i class="fa fa-bars"></i>Téléchargement des archives</h3>
					<ol class="breadcrumb">
						<li><i class="fa fa-home"></i><a href="/archives">Accueil Archives</a></li>
						<li><i class="fa fa-bars"></i><a href="/archives/archives">Liste des archives</a></li>
						<li><i class="fa fa-square-o"></i>Documents des archives</li>
					</ol>
				</div>
			</div>
			<section class="panel border-top">
				<div class="row">
					<div class="col-lg-12">
						<section class="panel">
							<div class="panel-heading" style="padding: 4px">
								<header class="panel-heading">
									Gestion des téléchargements
									<!-- Première modale pour afficher la miniature du document -->
									<div class="modal fade" tabindex="-1" role="dialog" id="documentThumbnailModal">
										<div class="modal-dialog" role="document" style="width: 50%">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title">Document</h5>
													<button type="button" class="close" data-dismiss="modal"
														aria-label="Close">
														<span aria-hidden="true">&times;</span>
													</button>
												</div>
												<div class="modal-body">
													<img id="archiveDocument" th:src="@{'/img/documents/avatar1.jpg'}"
														width="90%" height="90%">
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary"
														data-dismiss="modal">Fermer
													</button>
												</div>
											</div>
										</div>
									</div>
								</header>

								<!-- Afficher le message de succès en vert -->
								<div class="text-warning">
									<h3>[[${message}]] </h3>
								</div>

								<form th:action="@{/upload}" method="post" enctype="multipart/form-data">
									<div class="container mt-3">
										<div class="row justify-content-center">
											<div class="col-md-6">

												<div class="input-group mb-3">
													<input type="file" name="document" class="form-control" required>
												</div>

												<div class="text-center">
													<button type="submit" class="btn btn-primary">Upload</button>
												</div>

											</div>
										</div>
									</div>
								</form>



								<table class="table table-striped table-advance table-hover">
									<tbody>
										<tr>
											<th></th>
											<th><i class="fa fa-caret-right"></i>ID</th>
											<th><i class="fa fa-caret-right"></i>Nom</th>
											<th><i class="fa fa-caret-right"></i>Taille</th>
											<th><i class="icon_cogs"></i> Action</th>
										</tr>
										<tr th:each="archiveDocument:${archiveDocuments}">
											<td class="text-left">
												<div class="col-md-6">
													<!-- Bouton pour ouvrir la modale -->
													<th:block
														th:if="${archiveDocument.name.endsWith('.png') or archiveDocument.name.endsWith('.jpg') or archiveDocument.name.endsWith('.gif')}">
														<button
															th:if="${#strings.endsWith(archiveDocument.name, '.png') or #strings.endsWith(archiveDocument.name, '.jpg') or #strings.endsWith(archiveDocument.name, '.gif')}"
															class="btn btn-info btn-sm" data-toggle="modal"
															data-target="#documentThumbnailModal"
															th:attr="data-src=@{/download(id=${archiveDocument.id})}">Voir
															l'image</button>
														<!-- Lien de téléchargement du document avec décalage vers le haut -->
														<a th:href="@{'/download?id=' + ${archiveDocument.id}}"
															class="btn btn-primary btn-sm mt-2" role="button"
															target="_blank">
															Télécharger
														</a>
													</th:block>
												</div>
											</td>


											<td class="text-left" th:text="${archiveDocument.id}">Id</td>
											<td class="text-left" th:text="${archiveDocument.name}">Nom</td>
											<td class="text-left" th:text="${archiveDocument.size}">Taille</td>


											<!--td>
												<a style="width: 100%; word-wrap: break-word;" rows="4" cols="5"
													th:href="@{'/download?id=' + ${archiveDocument.id}}">[[${archiveDocument.name}]]</a>
											</td>-->

											<td>
												<div class="btn-group">
													<a class="btn btn-danger"
														onclick="confirm('Are you sure you want to delete?')"
														th:href="@{/archives/archiveDocuments/delete/{id}(id=${archiveDocument.id})}">
														<i class="icon_close_alt2"></i>
													</a>

												</div>
											</td>
										</tr>
									</tbody>
								</table>


							</div>

						</section>

			</section>
	</div>
	<!-- Script JavaScript pour gérer les modales -->

	<th:block layout:fragment="script">
		<script language="JavaScript">
			$('document').ready(function () {

				// Gestion de la deuxième modale pour afficher le document PDF
				$('.table button[data-target="#documentModal"]').on('click', function () {
					var documentUrl = $(this).data('src');
					var pdfViewer = document.getElementById('documentViewer');
					PDFJS.getDocument(documentUrl).then(function (pdf) {
						pdf.getPage(1).then(function (page) {
							var scale = 1.5;
							var viewport = page.getViewport({scale: scale});
							var canvas = document.createElement('canvas');
							var context = canvas.getContext('2d');
							canvas.height = viewport.height;
							canvas.width = viewport.width;
							var renderContext = {
								canvasContext: context,
								viewport: viewport
							};
							pdfViewer.innerHTML = '';
							pdfViewer.appendChild(canvas);
							page.render(renderContext);
						});
					});
				});
				// Gestion de la première modale pour afficher la miniature du document
				$('.table button[data-target="#documentThumbnailModal"]').on('click', function () {
					var documentThumbnailUrl = $(this).data('src');
					$('#documentThumbnailModal #archiveDocument').attr('src', documentThumbnailUrl);
				});

				// Gestion de la deuxième modale pour afficher le document complet
				$('.table button[data-target="#documentModal"]').on('click', function () {
					var documentUrl = $(this).data('src');
					$('#documentModal #documentViewer').attr('src', documentUrl);
				});
			});
		</script>
	</th:block>
</body>

</html>